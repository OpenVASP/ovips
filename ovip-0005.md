```
OVIP: 5
Title: Session Restoration
Author: Nika Gamkrelidze <nikoloz.gamkrelidze@lykke-business.ch>, Sergey Nesterov <sergey.nesterov@lykke-business.ch>, Ivelin Ivanov <ivelin.ivanov@lykke-business.ch>
Discussions-To: https://community.openvasp.org/#narrow/stream/12-implement-.2F.20all/topic/failover.20strategies
Status: Proposal
Type: Technical Clearification
Created: 2020-08-04
```

## Abstract

This OVIP is for fixing the issue of VASP not being able to gracefully handle the problematic transactions which might arise. Since restoring ongoing sessions is something that all production-grade clients will need to implement, this isn’t a huge overhead for development.
This OVIP is needed to fix all possible flow issues in conjunction with OVIP-0004.

## Specification

### General Description

As a general rule, to be able to implement it, all clients will need to store session info and persist it.

### 1. Introducing Interrupted state for Session

In OVIP-0004 it is described how in case of thechnical or business timeout the session might go into an Interrupted state. This means that the client marks session as Interrupted and stops listening to session topic and sending messages to counterparty topic so the state is frozen. As of now, it means that in case both parties want to finalize the business process, they have to set up a new session and go through the whole flow from the beginning which will most likely be unnecessary. It would be nice to be able to revive the session and continue from where the process was interrupted, which is what this OVIP suggests. The improvements described in OVIP-0004 make sure this is possible and easy to implement due to message idempotency and acknowledgement steps described.

### 2. Storing Session Info

All session info should be stored and made available in case of need. It is noteworthy that from the tech perspective, that means that one transfer from the business perspective can consist of several sessions, for example one interrupted and one which took off from the previous one and finished the flow gracefully. In case the interrupted session needs to be revived and resumed, both parties should have a mechanism enabling them to do that, so no matter in what state the session was interrupted, it will be possible for them to resume communication. It means that since the moment of first setup of the session, all the necessary information for listening to the relevant Whisper topic and composing/decomposing messages should be handled and stored by the host for the possible further use. This is much needed for restoring sessions in case business or tech timeouts have occured (OVIP-0004).

Let's imagine a flow along with OVIP-0004 to get a better feel of it:


#### 3. Scenario
```
OV settings:
Termination message TTL: 10 min
Termination max number of retries: 4

00:00 BV sends out Transfer Confirmation
00:01 OV receives Transfer Confirmation
00:10 OV sends out Termination
00:10 BV experiences downtime and doesn’t see the Termination
00:20 OV resends Termination because they didn’t receive Termination Ack
00:30 OV resends Termination because they didn’t receive Termination Ack
00:40 OV resends Termination because they didn’t receive Termination Ack
00:50 OV sees that number of retries exceeded the limit and marks session as interrupted
01:30 BV recovers from downtime and sees none of the messages in the blockchain since their TTL has already expired, marks session as interrupted
01:30 BV officer sees the interrupted session, confirms the state with the OV through a separate channel (mail, reporting, etc.)
01:50 OV revives session, resends Termination
01:51 BV receives Termination, understands that Termination Confirmation has been processed, sends Termination Ack, finalizes session
01:52 OV receives Termination Ack finalizes session
```
## Motivation

Uniformity - The terms of session revival need to be uniform across all clients, that is why it is important to include Session Revival in the protocol.

## Rationale

Minimal adjustment - This is the simplest solution since all clients will need to have session restoration mechanism implemented (for example for host restarts).
